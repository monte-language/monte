#!/bin/bash

# This runs every monte file in the standard library. This has two results:
#
# * Anything that has been broken by compiler errors will fail.
# * Many modules include tests, and these tests will run.

if [[ $MONTE_TESTS == "false" ]]; then
  exit 0
fi

tests=0
fails=0

for monteFile in $(find -name '*.mt'); do
  echo "Testing $monteFile"
  output=$(bin/monte "$monteFile")
  if [[ $? -ne 0 ]]; then
      fails=$((fails + 1))
      echo $output
  fi
  tests=$((tests + 1))
done

echo "$tests tests, $fails failures."

if [[ $fails -gt 0 ]]; then
  exit 1
fi
